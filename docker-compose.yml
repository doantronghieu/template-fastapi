# Pre-built images required: run `make docker-build` first

services:
  # FastAPI App (for containerized deployment)
  # For local development, use: make dev
  app:
    image: backend-ai:api
    platform: linux/amd64
    container_name: fastapi-app
    env_file: .env.docker
    ports:
      - "${PORT:-8000}:${PORT:-8000}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-8000}/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  celery-worker:
    image: backend-ai:celery
    platform: linux/amd64
    container_name: celery-worker
    command: uv run celery -A app.core.celery:celery_app worker --loglevel=info --concurrency=1 --pool=solo
    env_file: .env.docker

  flower:
    image: backend-ai:celery
    platform: linux/amd64
    container_name: flower
    command: uv run celery -A app.core.celery:celery_app flower --port=${FLOWER_PORT:-5555}
    env_file: .env.docker
    ports:
      - "${FLOWER_PORT:-5555}:${FLOWER_PORT:-5555}"

  celery-beat:
    image: backend-ai:celery
    platform: linux/amd64
    container_name: celery-beat
    command: uv run celery -A app.core.celery:celery_app beat --scheduler redbeat.schedulers:RedBeatScheduler --loglevel=info
    env_file: .env.docker

  # LiveKit Voice Agent
  voice-agent:
    build:
      context: .
      dockerfile: app/integrations/livekit/workers/Dockerfile
    container_name: voice-agent
    env_file:
      - .env.docker
      - envs/integrations/livekit.env
      - envs/integrations/deepgram.env
    restart: unless-stopped

# No volumes needed - using external database and Redis
